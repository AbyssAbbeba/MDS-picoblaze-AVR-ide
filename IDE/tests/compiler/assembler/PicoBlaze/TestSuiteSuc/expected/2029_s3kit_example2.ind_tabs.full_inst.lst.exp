  00041            1     character_a		EQU		0x41
  00046            2     character_f		EQU		0x46
  00049            3     character_i		EQU		0x49
  0004C            4     character_l		EQU		0x4c
  00050            5     character_p		EQU		0x50
  00053            6     character_s		EQU		0x53
                   7     ; KCPSM3 Program - LED control with Pulse Width Modulation (PWM).
                   8     ; Design provided for use with the design 'low_cost_design_authentication_for_spartan_3e.vhd'
                   9     ; and the Spartan-3E Starter Kit. This design provides the token 'real' application to be
                  10     ; protected by design authentication.
                  11     ;
                  12     ; Ken Chapman - Xilinx Ltd
                  13     ;
                  14     ; Version v1.00 - 9th November 2006
                  15     ;
                  16     ; This code automatically sequences the LEDs on the board using PWM to change intensity.
                  17     ; It also checks for correct design authentication and will perform a different sequence if
                  18     ; the design is not authorised.
                  19     device kcpsm2
                  20     ;
                  21     ;**************************************************************************************
                  22     ; NOTICE:
                  23     ;
                  24     ; Copyright Xilinx, Inc. 2006.   This code may be contain portions patented by other
                  25     ; third parties.  By providing this core as one possible implementation of a standard,
                  26     ; Xilinx is making no representation that the provided implementation of this standard
                  27     ; is free from any claims of infringement by any third party.  Xilinx expressly
                  28     ; disclaims any warranty with respect to the adequacy of the implementation, including
                  29     ; but not limited to any warranty or representation that the implementation is free
                  30     ; from claims of any third party.  Furthermore, Xilinx is providing this core as a
                  31     ; courtesy to you and suggests that you contact all third parties to obtain the
                  32     ; necessary rights to use this implementation.
                  33     ;
                  34     ;
                  35     ;**************************************************************************************
                  36     ; Port definitions
                  37     ;**************************************************************************************
                  38     ;
                  39     ;
                  40     ;
  00080           41     led_port		EQU		0x80			;8 simple LEDs
  00001           42     led0			EQU		0x01			;       LD0 - bit0
  00002           43     led1			EQU		0x02			;       LD1 - bit1
  00004           44     led2			EQU		0x04			;       LD2 - bit2
  00008           45     led3			EQU		0x08			;       LD3 - bit3
  00010           46     led4			EQU		0x10			;       LD4 - bit4
  00020           47     led5			EQU		0x20			;       LD5 - bit5
  00040           48     led6			EQU		0x40			;       LD6 - bit6
  00080           49     led7			EQU		0x80			;       LD7 - bit7
                  50     ;
  00000           51     led_read_port		EQU		0x00			;read back of current LED drive values
                  52     ;
                  53     ;
  00040           54     security_request_port	EQU		0x40			;Port to stimulate security KCPSM3 processor
  00001           55     security_interrupt	EQU		0x01			; interrupt - bit0
                  56     ;
                  57     ;
                  58     ;A FIFO buffer links the security KCPSM3 processor to the application KCPSM3 processor.
                  59     ;  This application processor controls and reads the FIFO.
                  60     ;  The security processor writes to the FIFO.
                  61     ;
  00020           62     link_fifo_control_port	EQU		0x20			;FIFO control
  00001           63     link_fifo_reset		EQU		0x01			;     reset - bit0
                  64     ;
  00001           65     link_fifo_status_port	EQU		0x01			;FIFO status input
  00001           66     link_fifo_data_present	EQU		0x01			;      half full - bit0
  00002           67     link_fifo_half_full	EQU		0x02			;           full - bit1
  00004           68     link_fifo_full		EQU		0x04			;   data present - bit2
                  69     ;
  00002           70     link_fifo_read_port	EQU		0x02			;read FIFO data
                  71     ;
                  72     ;
                  73     ;
                  74     ;**************************************************************************************
                  75     ; Special Register usage
                  76     ;**************************************************************************************
                  77     ;
                  78     ;
                  79     ;
                  80     ;
                  81     ;**************************************************************************************
                  82     ;Scratch Pad Memory Locations
                  83     ;**************************************************************************************
                  84     ;
  00000           85     pwm_duty_counter	EQU		0x00			;Duty Counter 0 to 255 within 1KHz period (1ms)
  00001           86     pwm_channel0		EQU		0x01			;PWM settings for each channel
  00002           87     pwm_channel1		EQU		0x02			; Channels 0 to 7 = LEDs 0 to 7
  00003           88     pwm_channel2		EQU		0x03
  00004           89     pwm_channel3		EQU		0x04
  00005           90     pwm_channel4		EQU		0x05
  00006           91     pwm_channel5		EQU		0x06
  00007           92     pwm_channel6		EQU		0x07
  00008           93     pwm_channel7		EQU		0x08
  0000D           94     isr_preserve_s0		EQU		0x0d			;preserve register contents during Interrupt Service Routine
  0000E           95     isr_preserve_s1		EQU		0x0e
  0000F           96     isr_preserve_s2		EQU		0x0f
                  97     ;
                  98     ;
  00010           99     led0_sequence		EQU		0x10			;LED sequence values
  00011          100     led1_sequence		EQU		0x11
  00012          101     led2_sequence		EQU		0x12
  00013          102     led3_sequence		EQU		0x13
  00014          103     led4_sequence		EQU		0x14
  00015          104     led5_sequence		EQU		0x15
  00016          105     led6_sequence		EQU		0x16
  00017          106     led7_sequence		EQU		0x17
                 107     ;
                 108     ;
                 109     ;
                 110     ;**************************************************************************************
                 111     ;Useful data constants
                 112     ;**************************************************************************************
                 113     ;
                 114     ;
                 115     ;
                 116     ;
                 117     ;
                 118     ;
                 119     ;
                 120     ;**************************************************************************************
                 121     ;Initialise the system
                 122     ;**************************************************************************************
                 123     ;
                 124     ; All PWM channels initialise to off (zero).
                 125     ; Simple I/O outputs will remain off at all times.
                 126     ;
000 00000        127     cold_start:		LOAD		s0, #0x00
001 00101        128     			LOAD		s1, #pwm_channel0
  00002          129     clear_loop:		STORE		s0, @s1
E: instruction not supported on the this device: STORE sX, sY.
                 130     			COMPARE		s1, #pwm_channel7
E: instruction not supported on the this device: COMPARE sX, kk.
002 35007        131     			JUMP		z, enable_int
003 08101        132     			ADD		s1, #0x01
004 34002        133     			JUMP		clear_loop
                 134     ;
005 3C001        135     enable_int:		ENABLE		interrupt		;interrupts used to set PWM frequency
                 136     ;
                 137     ;
                 138     ; Initialise LED pattern sequence
                 139     ;
006 00001        140     			LOAD		s0, #0x01		;trigger to start wave pattern
                 141     			STORE		s0, led0_sequence
E: instruction not supported on the this device: STORE sX, ss.
007 00000        142     			LOAD		s0, #0x00
                 143     			STORE		s0, led1_sequence
E: instruction not supported on the this device: STORE sX, ss.
                 144     			STORE		s0, led2_sequence
E: instruction not supported on the this device: STORE sX, ss.
                 145     			STORE		s0, led3_sequence
E: instruction not supported on the this device: STORE sX, ss.
                 146     			STORE		s0, led4_sequence
E: instruction not supported on the this device: STORE sX, ss.
                 147     			STORE		s0, led5_sequence
E: instruction not supported on the this device: STORE sX, ss.
                 148     			STORE		s0, led6_sequence
E: instruction not supported on the this device: STORE sX, ss.
                 149     			STORE		s0, led7_sequence
E: instruction not supported on the this device: STORE sX, ss.
                 150     ;
                 151     ;
                 152     ; Reset authentication check counter
                 153     ;
008 00F00        154     			LOAD		sf, #0x00
                 155     ;
                 156     ;
                 157     ;**************************************************************************************
                 158     ; Main program
                 159     ;**************************************************************************************
                 160     ;
                 161     ; Provides a pattern of interest on the LEDs :-)
                 162     ;
                 163     ; Each LED increases intensity in 8 steps and then decreases intensity in 8 steps until it is off.
                 164     ; The middle LEDs (LD2 to LD5) each start to turn on when either neighbour is turned half on and increasing
                 165     ; to provide the effect of a passing a 'wave' of light passing from side to side. The pair of LEDs at each
                 166     ; (LD0, Ld1 and LD6, LD7) are required to reflect the 'wave' so that the pattern continues.
                 167     ;
                 168     ; I'm sure this code cold be written in more elegant way, but I leave that as an exercise to you :-)
                 169     ;
                 170     ;
                 171     ; Using a simple software counter (implemented by register sF) the design occasionally requests an
                 172     ; authorisation message from the authentication processor. If it receives a PASS message it continues
                 173     ; normally but if it receives a FAIL message the LED pattern is changed.
                 174     ;
                 175     ;
                 176     ;
009 08F01        177     warm_start:		ADD		sf, #0x01		;authentication check timer
00A 358B6        178     			JUMP		c, authentication_check	;Check made approximately every 8 seconds.
                 179     ;
00B 00203        180     normal_led_sequence:	LOAD		s2, #0x03		;simple delay loop (delay will be increased by ISR processing)
00C 001FF        181     delay_s2_loop:		LOAD		s1, #0xff
00D 000FF        182     delay_s1_loop:		LOAD		s0, #0xff
00E 0C001        183     delay_s0_loop:		SUB		s0, #0x01
00F 35C18        184     			JUMP		nc, delay_s0_loop
010 0C101        185     			SUB		s1, #0x01
011 35C17        186     			JUMP		nc, delay_s1_loop
012 0C201        187     			SUB		s2, #0x01
013 35C16        188     			JUMP		nc, delay_s2_loop
                 189     ;
                 190     ;Pattern generation
                 191     ;
                 192     			FETCH		s0, led0_sequence	;read sequence for LED0
E: instruction not supported on the this device: FETCH sX, ss.
                 193     			COMPARE		s0, #0x00
E: instruction not supported on the this device: COMPARE sX, kk.
014 35026        194     			JUMP		z, test_led0_start
015 0C020        195     			SUB		s0, #0x20		;Count longer to ensure end stops then reset count if maximum
016 35029        196     			JUMP		z, update_led0
017 08020        197     			ADD		s0, #0x20
018 08001        198     inc_led0:		ADD		s0, #0x01		;increment counter
019 34029        199     			JUMP		update_led0
  00026          200     test_led0_start:	FETCH		s1, led1_sequence	;start LED0 if LED1 = 4
E: instruction not supported on the this device: FETCH sX, ss.
                 201     			COMPARE		s1, #0x04
E: instruction not supported on the this device: COMPARE sX, kk.
01A 35024        202     			JUMP		z, inc_led0
  00029          203     update_led0:		STORE		s0, led0_sequence
E: instruction not supported on the this device: STORE sX, ss.
01B 360A8        204     			CALL		led_to_duty
                 205     			STORE		s1, pwm_channel0
E: instruction not supported on the this device: STORE sX, ss.
                 206     ;
                 207     			FETCH		s1, led0_sequence	; refresh LED1 if LED0 = 11 (0B hex) to reflect wave
E: instruction not supported on the this device: FETCH sX, ss.
                 208     			COMPARE		s1, #0x0b
E: instruction not supported on the this device: COMPARE sX, kk.
01C 35431        209     			JUMP		nz, normal_led1
01D 00004        210     			LOAD		s0, #0x04
01E 3403F        211     			JUMP		update_led1
  00031          212     normal_led1:		FETCH		s0, led1_sequence	;read sequence for LED1
E: instruction not supported on the this device: FETCH sX, ss.
                 213     			COMPARE		s0, #0x00
E: instruction not supported on the this device: COMPARE sX, kk.
01F 35039        214     			JUMP		z, test_led1_start
020 0C010        215     			SUB		s0, #0x10		;reset count if maximum
021 3503F        216     			JUMP		z, update_led1
022 08010        217     			ADD		s0, #0x10
023 08001        218     inc_led1:		ADD		s0, #0x01		;increment counter
024 3403F        219     			JUMP		update_led1
  00039          220     test_led1_start:	FETCH		s1, led0_sequence	;start LED1 if LED0 = 11 (0B hex) to reflect wave
E: instruction not supported on the this device: FETCH sX, ss.
                 221     			COMPARE		s1, #0x0b
E: instruction not supported on the this device: COMPARE sX, kk.
025 35037        222     			JUMP		z, inc_led1
                 223     			FETCH		s1, led2_sequence	;start LED1 if LED2 = 4
E: instruction not supported on the this device: FETCH sX, ss.
                 224     			COMPARE		s1, #0x04
E: instruction not supported on the this device: COMPARE sX, kk.
026 35037        225     			JUMP		z, inc_led1
  0003F          226     update_led1:		STORE		s0, led1_sequence
E: instruction not supported on the this device: STORE sX, ss.
027 360A8        227     			CALL		led_to_duty
                 228     			STORE		s1, pwm_channel1
E: instruction not supported on the this device: STORE sX, ss.
                 229     ;
                 230     			FETCH		s0, led2_sequence	;read sequence for LED2
E: instruction not supported on the this device: FETCH sX, ss.
                 231     			COMPARE		s0, #0x00
E: instruction not supported on the this device: COMPARE sX, kk.
028 3504A        232     			JUMP		z, test_led2_start
029 0C010        233     			SUB		s0, #0x10		;reset count if maximum
02A 35050        234     			JUMP		z, update_led2
02B 08010        235     			ADD		s0, #0x10
02C 08001        236     inc_led2:		ADD		s0, #0x01		;increment counter
02D 34050        237     			JUMP		update_led2
  0004A          238     test_led2_start:	FETCH		s1, led1_sequence	;start LED2 if LED1 = 4
E: instruction not supported on the this device: FETCH sX, ss.
                 239     			COMPARE		s1, #0x04
E: instruction not supported on the this device: COMPARE sX, kk.
02E 35048        240     			JUMP		z, inc_led2
                 241     			FETCH		s1, led3_sequence	;start LED2 if LED3 = 4
E: instruction not supported on the this device: FETCH sX, ss.
                 242     			COMPARE		s1, #0x04
E: instruction not supported on the this device: COMPARE sX, kk.
02F 35048        243     			JUMP		z, inc_led2
  00050          244     update_led2:		STORE		s0, led2_sequence
E: instruction not supported on the this device: STORE sX, ss.
030 360A8        245     			CALL		led_to_duty
                 246     			STORE		s1, pwm_channel2
E: instruction not supported on the this device: STORE sX, ss.
                 247     ;
                 248     ;
                 249     			FETCH		s0, led3_sequence	;read sequence for LED3
E: instruction not supported on the this device: FETCH sX, ss.
                 250     			COMPARE		s0, #0x00
E: instruction not supported on the this device: COMPARE sX, kk.
031 3505B        251     			JUMP		z, test_led3_start
032 0C010        252     			SUB		s0, #0x10		;reset count if maximum
033 35061        253     			JUMP		z, update_led3
034 08010        254     			ADD		s0, #0x10
035 08001        255     inc_led3:		ADD		s0, #0x01		;increment counter
036 34061        256     			JUMP		update_led3
  0005B          257     test_led3_start:	FETCH		s1, led2_sequence	;start LED3 if LED2 = 4
E: instruction not supported on the this device: FETCH sX, ss.
                 258     			COMPARE		s1, #0x04
E: instruction not supported on the this device: COMPARE sX, kk.
037 35059        259     			JUMP		z, inc_led3
                 260     			FETCH		s1, led4_sequence	;start LED3 if LED4 = 4
E: instruction not supported on the this device: FETCH sX, ss.
                 261     			COMPARE		s1, #0x04
E: instruction not supported on the this device: COMPARE sX, kk.
038 35059        262     			JUMP		z, inc_led3
  00061          263     update_led3:		STORE		s0, led3_sequence
E: instruction not supported on the this device: STORE sX, ss.
039 360A8        264     			CALL		led_to_duty
                 265     			STORE		s1, pwm_channel3
E: instruction not supported on the this device: STORE sX, ss.
                 266     ;
                 267     			FETCH		s0, led4_sequence	;read sequence for LED4
E: instruction not supported on the this device: FETCH sX, ss.
                 268     			COMPARE		s0, #0x00
E: instruction not supported on the this device: COMPARE sX, kk.
03A 3506C        269     			JUMP		z, test_led4_start
03B 0C010        270     			SUB		s0, #0x10		;reset count if maximum
03C 35072        271     			JUMP		z, update_led4
03D 08010        272     			ADD		s0, #0x10
03E 08001        273     inc_led4:		ADD		s0, #0x01		;increment counter
03F 34072        274     			JUMP		update_led4
  0006C          275     test_led4_start:	FETCH		s1, led3_sequence	;start LED4 if LED3 = 4
E: instruction not supported on the this device: FETCH sX, ss.
                 276     			COMPARE		s1, #0x04
E: instruction not supported on the this device: COMPARE sX, kk.
040 3506A        277     			JUMP		z, inc_led4
                 278     			FETCH		s1, led5_sequence	;start LED4 if LED5 = 4
E: instruction not supported on the this device: FETCH sX, ss.
                 279     			COMPARE		s1, #0x04
E: instruction not supported on the this device: COMPARE sX, kk.
041 3506A        280     			JUMP		z, inc_led4
  00072          281     update_led4:		STORE		s0, led4_sequence
E: instruction not supported on the this device: STORE sX, ss.
042 360A8        282     			CALL		led_to_duty
                 283     			STORE		s1, pwm_channel4
E: instruction not supported on the this device: STORE sX, ss.
                 284     ;
                 285     			FETCH		s0, led5_sequence	;read sequence for LED5
E: instruction not supported on the this device: FETCH sX, ss.
                 286     			COMPARE		s0, #0x00
E: instruction not supported on the this device: COMPARE sX, kk.
043 3507D        287     			JUMP		z, test_led5_start
044 0C010        288     			SUB		s0, #0x10		;reset count if maximum
045 35083        289     			JUMP		z, update_led5
046 08010        290     			ADD		s0, #0x10
047 08001        291     inc_led5:		ADD		s0, #0x01		;increment counter
048 34083        292     			JUMP		update_led5
  0007D          293     test_led5_start:	FETCH		s1, led4_sequence	;start LED5 if LED4 = 4
E: instruction not supported on the this device: FETCH sX, ss.
                 294     			COMPARE		s1, #0x04
E: instruction not supported on the this device: COMPARE sX, kk.
049 3507B        295     			JUMP		z, inc_led5
                 296     			FETCH		s1, led6_sequence	;start LED5 if LED6 = 4
E: instruction not supported on the this device: FETCH sX, ss.
                 297     			COMPARE		s1, #0x04
E: instruction not supported on the this device: COMPARE sX, kk.
04A 3507B        298     			JUMP		z, inc_led5
  00083          299     update_led5:		STORE		s0, led5_sequence
E: instruction not supported on the this device: STORE sX, ss.
04B 360A8        300     			CALL		led_to_duty
                 301     			STORE		s1, pwm_channel5
E: instruction not supported on the this device: STORE sX, ss.
                 302     ;
                 303     			FETCH		s1, led7_sequence	; refresh LED6 if LED7 = 11 (0B hex) to reflect wave
E: instruction not supported on the this device: FETCH sX, ss.
                 304     			COMPARE		s1, #0x0b
E: instruction not supported on the this device: COMPARE sX, kk.
04C 3548B        305     			JUMP		nz, normal_led6
04D 00004        306     			LOAD		s0, #0x04
04E 34096        307     			JUMP		update_led6
  0008B          308     normal_led6:		FETCH		s0, led6_sequence	;read sequence for LED6
E: instruction not supported on the this device: FETCH sX, ss.
                 309     			COMPARE		s0, #0x00
E: instruction not supported on the this device: COMPARE sX, kk.
04F 35093        310     			JUMP		z, test_led6_start
050 0C010        311     			SUB		s0, #0x10		;reset count if maximum
051 35096        312     			JUMP		z, update_led6
052 08010        313     			ADD		s0, #0x10
053 08001        314     inc_led6:		ADD		s0, #0x01		;increment counter
054 34096        315     			JUMP		update_led6
  00093          316     test_led6_start:	FETCH		s1, led5_sequence	;start LED6 if LED5 = 4
E: instruction not supported on the this device: FETCH sX, ss.
                 317     			COMPARE		s1, #0x04
E: instruction not supported on the this device: COMPARE sX, kk.
055 35091        318     			JUMP		z, inc_led6
  00096          319     update_led6:		STORE		s0, led6_sequence
E: instruction not supported on the this device: STORE sX, ss.
056 360A8        320     			CALL		led_to_duty
                 321     			STORE		s1, pwm_channel6
E: instruction not supported on the this device: STORE sX, ss.
                 322     ;
                 323     			FETCH		s0, led7_sequence	;read sequence for LED7
E: instruction not supported on the this device: FETCH sX, ss.
                 324     			COMPARE		s0, #0x00
E: instruction not supported on the this device: COMPARE sX, kk.
057 350A1        325     			JUMP		z, test_led7_start
058 0C020        326     			SUB		s0, #0x20		;Count longer to ensure end stops then reset count if maximum
059 350A4        327     			JUMP		z, update_led7
05A 08020        328     			ADD		s0, #0x20
05B 08001        329     inc_led7:		ADD		s0, #0x01		;increment counter
05C 340A4        330     			JUMP		update_led7
  000A1          331     test_led7_start:	FETCH		s1, led6_sequence	;start LED7 if LED6 = 4
E: instruction not supported on the this device: FETCH sX, ss.
                 332     			COMPARE		s1, #0x04
E: instruction not supported on the this device: COMPARE sX, kk.
05D 3509F        333     			JUMP		z, inc_led7
  000A4          334     update_led7:		STORE		s0, led7_sequence
E: instruction not supported on the this device: STORE sX, ss.
05E 360A8        335     			CALL		led_to_duty
                 336     			STORE		s1, pwm_channel7
E: instruction not supported on the this device: STORE sX, ss.
05F 34013        337     			JUMP		warm_start
                 338     ;
                 339     ;
                 340     ; Convert LED sequence number into PWM intensity figure
                 341     ;
                 342     ; LEDs duty cycle values are 0,1,2,4,8,16,32 and 64 because they appear to give what
                 343     ; appears to be a fairly liner change in intensity and provides a simple way to set
                 344     ; the duty value.
                 345     ;
                 346     ; Provide sequence value in register s0 and intensity will be
                 347     ; returned in register s1.
                 348     ;
                 349     ; s0   s1
                 350     ; 00   00
                 351     ; 01   01
                 352     ; 02   02
                 353     ; 03   04
                 354     ; 04   08
                 355     ; 05   10
                 356     ; 06   20
                 357     ; 07   40
                 358     ; 08   80
                 359     ; 09   40
                 360     ; 0A   20
                 361     ; 0B   10
                 362     ; 0C   08
                 363     ; 0D   04
                 364     ; 0E   02
                 365     ; 0F   01
                 366     ; 10   00  and zero for all larger values of s0
                 367     ;
060 00100        368     led_to_duty:		LOAD		s1, #0x00
                 369     			COMPARE		s0, #0x00		;test for zero
E: instruction not supported on the this device: COMPARE sX, kk.
061 25000        370     			RETURN		z
062 00101        371     			LOAD		s1, #0x01		;inject '1'
063 0C001        372     go_up_loop:		SUB		s0, #0x01
064 25000        373     			RETURN		z
065 28106        374     			SL0		s1			;multiply by 2
066 358B1        375     			JUMP		c, go_down
067 340AC        376     			JUMP		go_up_loop
068 00140        377     go_down:		LOAD		s1, #0x40
069 0C001        378     go_down_loop:		SUB		s0, #0x01
06A 25000        379     			RETURN		z
06B 2810E        380     			SR0		s1			;divide by 2
06C 340B2        381     			JUMP		go_down_loop
                 382     ;
                 383     ;
                 384     ;
                 385     ;**************************************************************************************
                 386     ; Authentication Check and fail procedure
                 387     ;**************************************************************************************
                 388     ;
                 389     ; The authentication check is performed by issuing and interrupt to the authentication
                 390     ; processor and then observing the simple text string that it returns via the link FIFO
                 391     ; buffer.
                 392     ;
                 393     ; PASS - Design is authorised to work.
                 394     ; FAIL - Design is not authorised and should stop working normally.
                 395     ;
                 396     ;
                 397     ;ASCII character values that are used in messages
                 398     ;
                 399     ; >>>>> (line moved to the beginning) <<<<<
                 400     ; >>>>> (line moved to the beginning) <<<<<
                 401     ; >>>>> (line moved to the beginning) <<<<<
                 402     ; >>>>> (line moved to the beginning) <<<<<
                 403     ; >>>>> (line moved to the beginning) <<<<<
                 404     ; >>>>> (line moved to the beginning) <<<<<
                 405     ;
                 406     ;
06D 00001        407     authentication_check:	LOAD		s0, #link_fifo_reset	;clear link FIFO to ensure no unexpected characters
06E 22020        408     			OUTPUT		s0, link_fifo_control_port
06F 00000        409     			LOAD		s0, #0x00
070 22020        410     			OUTPUT		s0, link_fifo_control_port
                 411     ;
071 00001        412     			LOAD		s0, #security_interrupt	;generate interrupt to authentication processor
072 22040        413     			OUTPUT		s0, security_request_port
073 00000        414     			LOAD		s0, #0x00
074 22040        415     			OUTPUT		s0, security_request_port
                 416     ;
075 360F9        417     			CALL		read_link_fifo		;read each character and compare
                 418     			COMPARE		s0, #character_p
E: instruction not supported on the this device: COMPARE sX, kk.
076 354CB        419     			JUMP		nz, fail_confirm
077 360F9        420     			CALL		read_link_fifo
                 421     			COMPARE		s0, #character_a
E: instruction not supported on the this device: COMPARE sX, kk.
078 354CB        422     			JUMP		nz, fail_confirm
079 360F9        423     			CALL		read_link_fifo
                 424     			COMPARE		s0, #character_s
E: instruction not supported on the this device: COMPARE sX, kk.
07A 354CB        425     			JUMP		nz, fail_confirm
07B 360F9        426     			CALL		read_link_fifo
                 427     			COMPARE		s0, #character_s
E: instruction not supported on the this device: COMPARE sX, kk.
07C 354CB        428     			JUMP		nz, fail_confirm
07D 34015        429     			JUMP		normal_led_sequence	;Continue normal operation for PASS message
                 430     ;
                 431     ;
                 432     ; To confirm that the authentication is really a FAIL message
                 433     ; another request is made to the authentication processor and tested.
                 434     ;
07E 000FF        435     fail_confirm:		LOAD		s0, #0xff		;short delay to ensure authentication processor is ready
07F 0C001        436     request_delay:		SUB		s0, #0x01		;   to respond to new interrupt request
080 354CC        437     			JUMP		nz, request_delay
                 438     ;
081 00001        439     			LOAD		s0, #link_fifo_reset	;clear link FIFO to ensure no unexpected characters
082 22020        440     			OUTPUT		s0, link_fifo_control_port
083 00000        441     			LOAD		s0, #0x00
084 22020        442     			OUTPUT		s0, link_fifo_control_port
                 443     ;
085 00001        444     			LOAD		s0, #security_interrupt	;generate interrupt to authentication processor
086 22040        445     			OUTPUT		s0, security_request_port
087 00000        446     			LOAD		s0, #0x00
088 22040        447     			OUTPUT		s0, security_request_port
                 448     ;
089 360F9        449     			CALL		read_link_fifo		;read each character and compare
                 450     			COMPARE		s0, #character_f
E: instruction not supported on the this device: COMPARE sX, kk.
08A 35415        451     			JUMP		nz, normal_led_sequence
08B 360F9        452     			CALL		read_link_fifo
                 453     			COMPARE		s0, #character_a
E: instruction not supported on the this device: COMPARE sX, kk.
08C 35415        454     			JUMP		nz, normal_led_sequence
08D 360F9        455     			CALL		read_link_fifo
                 456     			COMPARE		s0, #character_i
E: instruction not supported on the this device: COMPARE sX, kk.
08E 35415        457     			JUMP		nz, normal_led_sequence
08F 360F9        458     			CALL		read_link_fifo
                 459     			COMPARE		s0, #character_l
E: instruction not supported on the this device: COMPARE sX, kk.
090 35415        460     			JUMP		nz, normal_led_sequence
                 461     ;
                 462     ;
                 463     ; When the design fails to authenticate the LEDs will appear to
                 464     ; turn on and then slowly fade to off using PWM.
                 465     ;
091 000FF        466     failed_led_sequence:	LOAD		s0, #0xff		;maximum intensity on all LEDs
092 00400        467     			LOAD		s4, #0x00		;reset fade rate control
093 00101        468     all_led_fade:		LOAD		s1, #pwm_channel0
  000E5          469     all_led_fade_loop:	STORE		s0, @s1
E: instruction not supported on the this device: STORE sX, sY.
                 470     			COMPARE		s1, #pwm_channel7
E: instruction not supported on the this device: COMPARE sX, kk.
094 350EA        471     			JUMP		z, decay_leds
095 08101        472     			ADD		s1, #0x01
096 340E5        473     			JUMP		all_led_fade_loop
097 10120        474     decay_leds:		LOAD		s1, s4			;software delay starts quickly and slows down because LEDs are non-linear.
098 00218        475     wait_s1:		LOAD		s2, #0x18
099 003FF        476     wait_s2:		LOAD		s3, #0xff
09A 0C301        477     wait_s3:		SUB		s3, #0x01
09B 354ED        478     			JUMP		nz, wait_s3
09C 0C201        479     			SUB		s2, #0x01
09D 354EC        480     			JUMP		nz, wait_s2
09E 0C101        481     			SUB		s1, #0x01
09F 354EB        482     			JUMP		nz, wait_s1
                 483     			COMPARE		s0, #0x00		;test for fully off
E: instruction not supported on the this device: COMPARE sX, kk.
0A0 350F8        484     			JUMP		z, stop_completely
0A1 0C001        485     			SUB		s0, #0x01		;fade LEDs
0A2 08401        486     			ADD		s4, #0x01		;slow fade rate as intensity decreases
0A3 340E4        487     			JUMP		all_led_fade
                 488     ;
0A4 340F8        489     stop_completely:	JUMP		stop_completely
                 490     ;
                 491     ;**************************************************************************************
                 492     ; Read Byte from Link FIFO
                 493     ;**************************************************************************************
                 494     ;
                 495     ; The routine first tests the FIFO buffer to see if data is present.
                 496     ; If the FIFO is empty, the routine waits until there is a character to read.
                 497     ; the read value is returned in register s0.
                 498     ;
                 499     ;
0A5 20001        500     read_link_fifo:		INPUT		s0, link_fifo_status_port	;test FIFO buffer
                 501     			TEST		s0, #link_fifo_data_present	;wait if empty
E: instruction not supported on the this device: TEST sX, kk.
0A6 350F9        502     			JUMP		z, read_link_fifo
0A7 20002        503     			INPUT		s0, link_fifo_read_port	;read data from FIFO
0A8 24000        504     			RETURN
                 505     ;
                 506     ;
                 507     ;**************************************************************************************
                 508     ; Interrupt Service Routine (ISR)
                 509     ;**************************************************************************************
                 510     ;
                 511     ; Interrupts occur at 3.92us intervals and are used to generate the PWM pulses generated
                 512     ; at a PRF of 1KHz. The 3.92us interrupt rate corresponds with a resolution of 256 steps
                 513     ; over the 1ms associated with the 1KHz PRF.
                 514     ;
                 515     ; The ISR is self contained and all registers used are preserved. Scratch pad memory
                 516     ; locations are used to determine the desired duty factor for each of 8 channels.
                 517     ;
                 518     ; Note that an interrupt is generated every 196 clock cycles. This means that there is
                 519     ; only time to execute 98 instructions between each interrupt. This ISR is 35 instructions
                 520     ; long. A further 3 instructions are also consumed by the interrupt process
                 521     ; (abandoned instruction, virtual CALL to 3FF and the interrupt vector JUMP) and hence
                 522     ; PicoBlaze has approximately 63% of its time available for other tasks in the main program.
                 523     ;
                 524     ; Although a loop would normal be employed in software to process each of 8 channels,
                 525     ; the implementation of a loop would increase the number of instructions which needed to
                 526     ; be executed significantly reduce the time available for the main program to operate.
                 527     ; Consequently the code is written out in a linear fashion which consumes more program
                 528     ; space but which executes faster.
                 529     ;
  000FE          530     isr:			STORE		s0, isr_preserve_s0	;preserve registers to be used
E: instruction not supported on the this device: STORE sX, ss.
                 531     			STORE		s1, isr_preserve_s1
E: instruction not supported on the this device: STORE sX, ss.
                 532     			STORE		s2, isr_preserve_s2
E: instruction not supported on the this device: STORE sX, ss.
                 533     ;Determine the number of steps currently through the 1ms PWM cycle
                 534     			FETCH		s1, pwm_duty_counter	;read 8-bit counter of steps
E: instruction not supported on the this device: FETCH sX, ss.
0A9 08101        535     			ADD		s1, #0x01		;increment counter (will roll over to zero)
                 536     			STORE		s1, pwm_duty_counter	;update count value in memory for next interrupt.
E: instruction not supported on the this device: STORE sX, ss.
                 537     ;Read duty factor for each channel and compare it with the duty counter and set or
                 538     ;reset a bit in register s2 accordingly.
                 539     			FETCH		s0, pwm_channel7	;read desired setting of pulse width
E: instruction not supported on the this device: FETCH sX, ss.
                 540     			COMPARE		s1, s0			;set carry flag if duty factor > duty counter
E: instruction not supported on the this device: COMPARE sX, sY.
0AA 28200        541     			SLA		s2			;shift carry into register s2
                 542     			FETCH		s0, pwm_channel6	;read desired setting of pulse width
E: instruction not supported on the this device: FETCH sX, ss.
                 543     			COMPARE		s1, s0			;set carry flag if duty factor > duty counter
E: instruction not supported on the this device: COMPARE sX, sY.
0AB 28200        544     			SLA		s2			;shift carry into register s2
                 545     			FETCH		s0, pwm_channel5	;read desired setting of pulse width
E: instruction not supported on the this device: FETCH sX, ss.
                 546     			COMPARE		s1, s0			;set carry flag if duty factor > duty counter
E: instruction not supported on the this device: COMPARE sX, sY.
0AC 28200        547     			SLA		s2			;shift carry into register s2
                 548     			FETCH		s0, pwm_channel4	;read desired setting of pulse width
E: instruction not supported on the this device: FETCH sX, ss.
                 549     			COMPARE		s1, s0			;set carry flag if duty factor > duty counter
E: instruction not supported on the this device: COMPARE sX, sY.
0AD 28200        550     			SLA		s2			;shift carry into register s2
                 551     			FETCH		s0, pwm_channel3	;read desired setting of pulse width
E: instruction not supported on the this device: FETCH sX, ss.
                 552     			COMPARE		s1, s0			;set carry flag if duty factor > duty counter
E: instruction not supported on the this device: COMPARE sX, sY.
0AE 28200        553     			SLA		s2			;shift carry into register s2
                 554     			FETCH		s0, pwm_channel2	;read desired setting of pulse width
E: instruction not supported on the this device: FETCH sX, ss.
                 555     			COMPARE		s1, s0			;set carry flag if duty factor > duty counter
E: instruction not supported on the this device: COMPARE sX, sY.
0AF 28200        556     			SLA		s2			;shift carry into register s2
                 557     			FETCH		s0, pwm_channel1	;read desired setting of pulse width
E: instruction not supported on the this device: FETCH sX, ss.
                 558     			COMPARE		s1, s0			;set carry flag if duty factor > duty counter
E: instruction not supported on the this device: COMPARE sX, sY.
0B0 28200        559     			SLA		s2			;shift carry into register s2
                 560     			FETCH		s0, pwm_channel0	;read desired setting of pulse width
E: instruction not supported on the this device: FETCH sX, ss.
                 561     			COMPARE		s1, s0			;set carry flag if duty factor > duty counter
E: instruction not supported on the this device: COMPARE sX, sY.
0B1 28200        562     			SLA		s2			;shift carry into register s2
0B2 22280        563     			OUTPUT		s2, led_port		;drive LEDs
                 564     			FETCH		s0, isr_preserve_s0	;restore register values
E: instruction not supported on the this device: FETCH sX, ss.
                 565     			FETCH		s1, isr_preserve_s1
E: instruction not supported on the this device: FETCH sX, ss.
                 566     			FETCH		s2, isr_preserve_s2
E: instruction not supported on the this device: FETCH sX, ss.
0B3 2C001        567     			RETURNI		enable
                 568     ;
                 569     ;
                 570     ;**************************************************************************************
                 571     ; Interrupt Vector
                 572     ;**************************************************************************************
                 573     ;
  003FF          574     			ORG		0x3ff
3FF 340FE        575     			JUMP		isr
                 576     ;
                 577     ;
                 578
